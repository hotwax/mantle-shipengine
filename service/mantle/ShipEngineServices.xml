<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!-- ============================================= -->
    <!-- ========== Shipping Rate Service ============ -->
    <!-- ============================================= -->

    <service verb="get" noun="ShippingRate">
        <!-- see: https://www.shipengine.com/docs/rates/#example-with-shipment-details -->
        <implements service="mantle.shipment.CarrierServices.get#ShippingRate"/>
        <out-parameters>
            <parameter name="responseMap"/>
        </out-parameters>
        <actions>

            <!-- ==============  API-Key Authentication  ============== -->

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayOption" value-field="apiTokenOpt">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="optionEnumId" value="SgoApiToken"/>
            </entity-find-one>
            <set field="apiToken" from="apiTokenOpt?.optionValue"/>
            <if condition="!apiToken">
                <log level="warn" message="Shipping gateway config ${shippingGatewayConfigId} has no SgoApiToken, not getting rates"/>
                <return/>
            </if>


            <!-- ==============  Shipment_Record  ============== -->

            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment" for-update="true"/>
            <if condition="shipment == null">
                <return error="true" message="Shipment not found with ID ${shipmentId}"/>
            </if>
            <entity-find-one entity-name="mantle.shipment.ShipmentRouteSegment" value-field="routeSegment"/>
            <if condition="routeSegment == null">
                <return error="true" message="Shipment Route Segment not found with ID ${shipmentId}:${shipmentRouteSegmentSeqId}"/>
            </if>
            <set field="originPostalContactMechId" from="routeSegment.originPostalContactMechId"/>
            <set field="destPostalContactMechId" from="routeSegment.destPostalContactMechId"/>

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayMethod" value-field="gatewayMethod">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="carrierPartyId" from="routeSegment.carrierPartyId"/>
                <field-map field-name="shipmentMethodEnumId" from="routeSegment.shipmentMethodEnumId"/>
            </entity-find-one>
            <set field="serviceCode" from="[gatewayMethod.gatewayServiceCode]"/>
            <if condition="!gatewayMethod">
                <log level="warn" message="Shipping gateway config ${shippingGatewayConfigId} has no ShippingGatewayMethod, not getting rates"/>
                <return/>
            </if>
            <if condition="!serviceCode">
                <log level="warn" message="Shipping gateway config ${shippingGatewayConfigId} has no gatewayServiceCode, not getting rates"/>
                <return/>
            </if>


            <!-- ==============  Carrier_Id  ============== -->

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayCarrier" value-field="gatewayCarrier">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="carrierPartyId" from="routeSegment.carrierPartyId"/>
            </entity-find-one>
            <set field="carrierIds" type="List" from="[gatewayCarrier.gatewayAccountId]"/>
            <if condition="!carrierIds">
                <log level="warn" message="Shipping Gateway config ${shippingGatewayConfigId} has no carrierId, not getting rates"/>
                <return/>
            </if>


            <!-- ==============  Address_to  ============== -->

            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="destAddress">
                <field-map field-name="contactMechId" from="routeSegment.destPostalContactMechId"/>
            </entity-find-one>
            <script> indicatorTo = (destAddress.commercial==null || destAddress.commercial=='N') ? 'No' : 'Yes' </script>
            <if condition="!destAddress.stateProvinceGeoId">
                <log level="warn" message="This contactMechId ${contactMechId} has no stateProvinceGeoId, not getting rates"/>
                <return/>
            </if>
            <if condition="!destAddress.telecomContactMechId">
                <log level="warn" message="This contactMechId ${contactMechId} has no telecomContactMechId, not getting rates"/>
                <return/>
            </if>

            <entity-find-one entity-name="moqui.basic.Geo" value-field="destState">
                <field-map field-name="geoId" from="destAddress.stateProvinceGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="destCountry">
                <field-map field-name="geoId" from="destAddress.countryGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="mantle.party.contact.TelecomNumber" value-field="destTelecomNumber">
                <field-map field-name="contactMechId" from="destAddress.telecomContactMechId"/>
            </entity-find-one>
            <set field="number" from="destTelecomNumber.areaCode+'-'+destTelecomNumber.contactNumber"/>
            <set field="shipTo" from="[name:destAddress.toName,phone:number,address_line1:destAddress.address1,
                                       city_locality: destAddress.city,state_province:destState.geoCodeAlpha2,
                                       postal_code:destAddress.postalCode,country_code:destCountry.geoCodeAlpha2,
                                       address_residential_indicator:indicatorTo ]"/>

            <!-- ==============  Address_From  ============== -->

            <if condition="!originPostalContactMechId &amp;&amp; routeSegment.originFacilityId">
                <service-call name="mantle.facility.ContactServices.get#FacilityDefaultShipOrigin" out-map="facOriginOut"
                              in-map="[facilityId:routeSegment.originFacilityId]"/>
                <if condition="facOriginOut.postalContactMechId">
                    <set field="originPostalContactMechId" from="facOriginOut.postalContactMechId"/>
                    <set field="routeSegment.originPostalContactMechId" from="originPostalContactMechId"/>
                    <entity-update value-field="routeSegment"/>
                </if>
            </if>

            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="originAddress">
                <field-map field-name="contactMechId" from="routeSegment.originPostalContactMechId"/>
            </entity-find-one>
            <script>
                indicatorFrom = (originAddress.commercial==null || originAddress.commercial=='N') ? 'Yes' : 'No'
            </script>
            <if condition="!originAddress.stateProvinceGeoId">
                <log level="warn" message="This contactMechId ${contactMechId} has no stateProvinceGeoId, not getting rates"/>
                <return/>
            </if>
            <if condition="!originAddress.telecomContactMechId">
                <log level="warn" message="This contactMechId ${contactMechId} has no telecomContactMechId, not getting rates"/>
                <return/>
            </if>

            <entity-find-one entity-name="moqui.basic.Geo" value-field="originState">
                <field-map field-name="geoId" from="originAddress.stateProvinceGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="originCountry">
                <field-map field-name="geoId" from="originAddress.countryGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="mantle.party.contact.TelecomNumber" value-field="originTelecomNumber">
                <field-map field-name="contactMechId" from="originAddress.telecomContactMechId"/>
            </entity-find-one>
            <set field="number" from="originTelecomNumber.areaCode+'-'+originTelecomNumber.contactNumber"/>
            <set field="shipFrom" from="[name:originAddress.toName,phone:number,address_line1:originAddress.address1,
                                         city_locality: originAddress.city, state_province:originState.geoCodeAlpha2,
                                         postal_code:originAddress.postalCode,country_code:originCountry.geoCodeAlpha2,
                                         address_residential_indicator:indicatorFrom]"/>


            <!-- ==============  Packages  ============== -->

            <entity-find-one entity-name="mantle.shipment.ShipmentPackage" value-field="shipmentPackage">
                <field-map field-name="shipmentId"/>
                <field-map field-name="shipmentPackageSeqId" />
            </entity-find-one>
            <if condition="!shipmentPackage.weightUomId">
                <log level="warn" message="This shipmentId ${shipmentId} has no Shipment package, not getting rates"/>
                <return/>
            </if>
            <entity-find-one entity-name="moqui.basic.UomConversion" value-field="conversion">
                <field-map field-name="uomId" from="shipmentPackage.weightUomId"/>
                <field-map field-name="toUomId" value="WT_oz"/>
            </entity-find-one>
            <set field="convertedWeight" from="shipmentPackage.weight*conversion.conversionFactor"/>
            <if condition="!convertedWeight">
                <log level="warn" message="This ShipmentId ${shipmentId} has no weight in ShipmentPackage, not getting rates"/>
                <return/>
            </if>
            <set field="weight" from="[value: convertedWeight, unit: 'ounce']"/>

            <set field="packageList" from="[weight:weight]"/>
            <set field="packages" from="[packageList]"/>
            <set field="shipment" from="[validateAddress:'noValidation',ship_to:shipTo,ship_from:shipFrom,packages:packages]"/>
            <set field="rateOptions" from="[carrier_ids:carrierIds,service_codes:serviceCode]"/>
            <set field="requestMap" from= "[rate_options:rateOptions,shipment:shipment]"/>
            <set field="responseMap" from="[]"/>
            <set field="errMsg" type="String"/>

            <script>
                <![CDATA[
                    org.moqui.util.RestClient restClient = ec.service.rest().method(org.moqui.util.RestClient.POST)
                    .addHeader("API-Key", "${apiToken}")
                    .addHeader("Content-Type", "application/json").jsonObject(requestMap)
                    restClient.uri().protocol("https").host("api.shipengine.com").port(443).path("v1/rates").build()
                    org.moqui.util.RestClient.RestResponse restResponse = restClient.call()
                    if (restResponse.statusCode < 200 || restResponse.statusCode >= 300) { ec.logger.warn("Unsuccessful with status code: ${statusCode} and response: ${response}") return }
                    responseMap = restResponse.jsonObject()
                ]]>
            </script>
        </actions>
    </service>

    <!-- ============================================= -->
    <!-- ========== Create Label Service ============= -->
    <!-- ============================================= -->

    <service verb="post" noun="CreateLabel">
        <implements service="mantle.shipment.CarrierServices.request#ShippingLabels"/>
        <out-parameters>
            <parameter name="responseMap"/>
        </out-parameters>
        <actions>

            <!-- ==============  API-Key Authentication  ============== -->

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayOption" value-field="apiTokenOpt">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="optionEnumId" value="SgoApiToken"/>
            </entity-find-one>
            <set field="apiToken" from="apiTokenOpt?.optionValue"/>
            <if condition="!apiToken">
                <log level="warn" message="Shipping gateway config ${shippingGatewayConfigId} has no SgoApiToken, not getting rates"/>
                <return/>
            </if>
            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayOption" value-field="gatewayOption">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="optionEnumId" value="SgoLabelType"/>
            </entity-find-one>
            <set field="label" from="gatewayOption?.optionValue"/>


            <!-- ==============  Shipment_Record  ============== -->

            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment" for-update="true"/>
            <if condition="shipment == null">
                <return error="true" message="Shipment not found with ID ${shipmentId}"/>
            </if>
            <entity-find-one entity-name="mantle.shipment.ShipmentRouteSegment" value-field="routeSegment"/>
            <if condition="routeSegment == null">
                <return error="true" message="Shipment Route Segment not found with ID ${shipmentId}:${shipmentRouteSegmentSeqId}"/>
            </if>
            <set field="originPostalContactMechId" from="routeSegment.originPostalContactMechId"/>
            <set field="destPostalContactMechId" from="routeSegment.destPostalContactMechId"/>

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayMethod" value-field="gatewayMethod">
                <field-map field-name="shippingGatewayConfigId"/>
                <field-map field-name="carrierPartyId" from="routeSegment.carrierPartyId"/>
                <field-map field-name="shipmentMethodEnumId" from="routeSegment.shipmentMethodEnumId"/>
            </entity-find-one>
            <set field="serviceCode" from="gatewayMethod.gatewayServiceCode"/>
            <if condition="!gatewayMethod">
                <log level="warn" message="Shipping gateway ===${shippingGatewayConfigId}=== has no ShippingGatewayMethod, not getting rates"/>
                <return/>
            </if>
            <if condition="!serviceCode">
                <log level="warn" message="Shipping gateway ===${shippingGatewayConfigId}=== has no gatewayServiceCode, not getting rates"/>
                <return/>
            </if>


            <!-- ==============  Address_to  ============== -->

            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="destAddress">
                <field-map field-name="contactMechId" from="routeSegment.destPostalContactMechId"/>
            </entity-find-one>
            <script>
                indicatorTo = (destAddress.commercial==null || destAddress.commercial=='N') ? 'No' : 'Yes'
            </script>
            <if condition="!destAddress.stateProvinceGeoId">
                <log level="warn" message="This contactMechId ${contactMechId} has no stateProvinceGeoId, not getting rates"/>
                <return/>
            </if>
            <if condition="!destAddress.telecomContactMechId">
                <log level="warn" message="This contactMechId ${contactMechId} has no telecomContactMechId, not getting rates"/>
                <return/>
            </if>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="destState">
                <field-map field-name="geoId" from="destAddress.stateProvinceGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="destCountry">
                <field-map field-name="geoId" from="destAddress.countryGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="mantle.party.contact.TelecomNumber" value-field="destTelecomNumber">
                <field-map field-name="contactMechId" from="destAddress.telecomContactMechId"/>
            </entity-find-one>
            <set field="number" from="destTelecomNumber.areaCode+'-'+destTelecomNumber.contactNumber"/>
            <set field="shipTo" from="[name:destAddress.toName,phone:number,address_line1:destAddress.address1,
                                       city_locality: destAddress.city,state_province:destState.geoCodeAlpha2,
                                       postal_code:destAddress.postalCode,country_code:destCountry.geoCodeAlpha2,
                                       address_residential_indicator:indicatorTo ]"/>


            <!-- ==============  Address_From  ============== -->

            <if condition="!originPostalContactMechId &amp;&amp; routeSegment.originFacilityId">
                <service-call name="mantle.facility.ContactServices.get#FacilityDefaultShipOrigin" out-map="facOriginOut"
                              in-map="[facilityId:routeSegment.originFacilityId]"/>
                <if condition="facOriginOut.postalContactMechId">
                    <set field="originPostalContactMechId" from="facOriginOut.postalContactMechId"/>
                    <set field="routeSegment.originPostalContactMechId" from="originPostalContactMechId"/>
                    <entity-update value-field="routeSegment"/>
                </if>
            </if>

            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="originAddress">
                <field-map field-name="contactMechId" from="routeSegment.originPostalContactMechId"/>
            </entity-find-one>
            <script>
                indicatorFrom = (originAddress.commercial==null || originAddress.commercial=='N') ? 'Yes' : 'No'
            </script>
            <if condition="!originAddress.stateProvinceGeoId">
                <log level="warn" message="This contactMechId ===${contactMechId}=== has no stateProvinceGeoId, not getting rates"/>
                <return/>
            </if>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="originState">
                <field-map field-name="geoId" from="originAddress.stateProvinceGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="moqui.basic.Geo" value-field="originCountry">
                <field-map field-name="geoId" from="originAddress.countryGeoId"/>
            </entity-find-one>
            <entity-find-one entity-name="mantle.party.contact.TelecomNumber" value-field="originTelecomNumber">
                <field-map field-name="contactMechId" from="originAddress.telecomContactMechId"/>
            </entity-find-one>
            <set field="number" from="originTelecomNumber.areaCode+'-'+originTelecomNumber.contactNumber"/>
            <set field="shipFrom" from="[name:originAddress.toName,phone:number,address_line1:originAddress.address1,
                                         city_locality: originAddress.city, state_province:originState.geoCodeAlpha2,
                                         postal_code:originAddress.postalCode,country_code:destCountry.geoCodeAlpha2,
                                         address_residential_indicator:indicatorFrom]"/>


            <!-- ==============  Packages  ============== -->

            <entity-find-one entity-name="mantle.shipment.ShipmentPackage" value-field="shipmentPackage">
                <field-map field-name="shipmentId"/>
                <field-map field-name="shipmentPackageSeqId" />
            </entity-find-one>
            <if condition="!shipmentPackage.weightUomId">
                <log level="warn" message="This shipmentId ${shipmentId} has no Shipment package, not getting rates"/>
                <return/>
            </if>
            <entity-find-one entity-name="moqui.basic.UomConversion" value-field="conversion">
                <field-map field-name="uomId" from="shipmentPackage.weightUomId"/>
                <field-map field-name="toUomId" value="WT_oz"/>
            </entity-find-one>
            <set field="convertedWeight" from="shipmentPackage.weight*conversion.conversionFactor"/>
            <entity-find-one entity-name="mantle.shipment.ShipmentBoxType" value-field="box">
                <field-map field-name="shipmentBoxTypeId" from="shipmentPackage.shipmentBoxTypeId"/>
            </entity-find-one>

            <set field="dimensions" from="[height:box.boxHeight,width:box.boxWidth,length:box.boxLength,unit:'inch']"/>
            <set field="weight" from="[value: convertedWeight, unit: 'ounce']"/>
            <set field="packageList" from="[weight:weight,dimensions:dimensions]"/>
            <set field="packages" from="[packageList]"/>
            <set field="shipment" from="[service_code:serviceCode,ship_to:shipTo,ship_from:shipFrom,confirmation:'none',insurance_provider:'none',packages:packages]"/>
            <set field="labelLayout" from="[label:label]"/>
            <set field="requestMap" from= "[shipment:shipment]"/>
            <set field="responseMap" from="[]"/>
            <set field="errMsg" type="String"/>

            <script>
                <![CDATA[
                    org.moqui.util.RestClient restClient = ec.service.rest().method(org.moqui.util.RestClient.POST)
                    .addHeader("API-Key", "${apiToken}")
                    .addHeader("Content-Type", "application/json").jsonObject(requestMap)
                    restClient.uri().protocol("https").host("api.shipengine.com").port(443).path("v1/labels").build()
                    org.moqui.util.RestClient.RestResponse restResponse = restClient.call()
                    if (restResponse.statusCode < 200 || restResponse.statusCode >= 300) { ec.logger.warn("Unsuccessful with status code: ${statusCode} and response: ${response}") return }
                    responseMap = restResponse.jsonObject()
                ]]>
            </script>

            <!-- ==============  Always save result from response  ============== -->

            <entity-find-one entity-name="mantle.shipment.ShipmentPackageRouteSeg" value-field="packageRouteSeg">
                <field-map field-name="shipmentId"/>
                <field-map field-name="shipmentRouteSegmentSeqId"/>
                <field-map field-name="shipmentPackageSeqId"/>
            </entity-find-one>

                <set field="packageRouteSeg.gatewayStatus" from="responseMap.status"/>
                <set field="packageRouteSeg.gatewayLabelId" from="responseMap.label_id"/>
                <set field="packageRouteSeg.gatewayRateId" from="rateInfo != null ? rateInfo.shippoObjectId : responseMap.rate?.object_id"/>
                <set field="packageRouteSeg.estimatedAmount" from="responseMap.shipment_cost?.amount as BigDecimal"/>
                <set field="packageRouteSeg.baseAmount" from="packageRouteSeg.estimatedAmount"/>
                <set field="packageRouteSeg.trackingStatusEnumId" value="ShTsUnknown"/>
                <set field="packageRouteSeg.trackingSubStatus" from="responseMap.tracking_status"/>
                <set field="packageRouteSeg.trackingCode" from="responseMap.tracking_number"/>
                <set field="packageRouteSeg.trackingUrl" from="responseMap.tracking_url_provider"/>
                <set field="packageRouteSeg.labelDate" from="ec.l10n.parseTimestamp(responseMap.created_at, 'yyyy-MM-dd\'T\'HH:mm:ss.SSSZ')"/>
                <set field="packageRouteSeg.labelUrl" from="responseMap.label_download?.pdf"/>
                <set field="packageRouteSeg.labelImage" from="responseMap.label_download?.png"/>
                <set field="packageRouteSeg.insuranceAmount" from="responseMap.insurance_cost?.amount"/>

            <entity-update value-field="packageRouteSeg"/>
        </actions>
    </service>

    <!-- ============================================= -->
    <!-- ========== Void Label Service =============== -->
    <!-- ============================================= -->

    <service verb="put" noun="VoidLabel">
        <in-parameters>
            <parameter name="shipmentId" required="true"/>
            <parameter name="shipmentRouteSegmentSeqId" required="true"/>
            <parameter name="shipmentPackageSeqId"/>
            <parameter name="shippingGatewayConfigId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="responseMap"/>
        </out-parameters>
        <actions>

            <!-- ==============  API-Key Authentication  ============== -->

            <entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayOption" value-field="apiTokenOpt">
                <field-map field-name="shippingGatewayConfigId" value="SHIPENGINE_DEMO"/>
                <field-map field-name="optionEnumId" value="SgoApiToken"/>
            </entity-find-one>
            <set field="apiToken" from="apiTokenOpt?.optionValue"/>
            <if condition="!apiToken">
                <log level="warn" message="Shipping gateway config ${shippingGatewayConfigId} has no SgoApiToken, not getting rates"/>
                <return/>
            </if>


            <!-- ============== Shipment Record ============== -->

            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment" for-update="true"/>
            <if condition="shipment == null">
                <return error="true" message="Shipment not found with ID ${shipmentId}"/>
            </if>
            <entity-find-one entity-name="mantle.shipment.ShipmentRouteSegment" value-field="routeSegment"/>
            <if condition="routeSegment == null">
                <return error="true" message="Shipment Route Segment not found with ID ${shipmentId}:${shipmentRouteSegmentSeqId}"/>
            </if>
            <entity-find-one entity-name="mantle.shipment.ShipmentPackage" value-field="packages"/>
            <if condition="packages == null">
                <log level="warn" message="Shipment Package not found with ID ${shipmentId}:${shipmentPackageSeqId}"/>
            </if>


            <!-- ==============  Package Route Segment  ============== -->

            <entity-find-one entity-name="mantle.shipment.ShipmentPackageRouteSeg" value-field="packageRouteSeg">
                <field-map field-name="shipmentId"/>
                <field-map field-name="shipmentRouteSegmentSeqId"/>
                <field-map field-name="shipmentPackageSeqId" />
            </entity-find-one>
            <if condition="!packageRouteSeg.gatewayLabelId">
                <return error="true" message="Label Id not found with Shipment Package ${shipmentId}:${shipmentPackageSeqId}"/>
            </if>
            <set field="labelId" from="packageRouteSeg.gatewayLabelId"/>

            <script>
                <![CDATA[
                    org.moqui.util.RestClient restClient = ec.service.rest().method(org.moqui.util.RestClient.PUT)
                    .addHeader("API-Key", "${apiToken}")
                    restClient.uri().protocol("https").host("api.shipengine.com").port(443).path("v1/labels/${labelId}/void").build()
                    org.moqui.util.RestClient.RestResponse restResponse = restClient.call()
                    if (restResponse.statusCode < 200 || restResponse.statusCode >= 300) { ec.logger.warn("Unsuccessful with status code: ${statusCode} and response: ${response}") return }
                    responseMap = restResponse.jsonObject()
                ]]>
            </script>
        </actions>
    </service>

</services>

